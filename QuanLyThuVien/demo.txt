/* 1. Bảng TACGIA (Không đổi) */
CREATE TABLE TACGIA (
    maTacGia NVARCHAR(50) PRIMARY KEY,
    tenTacGia NVARCHAR(100) NOT NULL,
    email NVARCHAR(100) NULL,
    sdt NVARCHAR(20) NULL,
    chucDanh NVARCHAR(100) NULL
);

/* 2. Bảng SACH (Đã BỎ cột maTacGia) */
CREATE TABLE SACH (
    maSach NVARCHAR(50) PRIMARY KEY,
    tenSach NVARCHAR(255) NOT NULL,
    
    /* --- ĐÃ BỎ CỘT maTacGia VÀ KHÓA NGOẠI TẠI ĐÂY --- */
    
    nhaXuatBan NVARCHAR(150) NULL,
    namXuatBan INT NULL,
    soLuong INT NOT NULL DEFAULT 0,
    moTa NTEXT NULL,
    duongDanAnh NVARCHAR(255) NULL,
    viTri NVARCHAR(100) NULL,
    ngayThem DATETIME NOT NULL DEFAULT GETDATE(),
    isArchived BIT NOT NULL DEFAULT 0,
    conLai INT NOT NULL DEFAULT 0
);

/* 3. Bảng TRUNG GIAN (MỚI) để liên kết Nhiều-Nhiều */
CREATE TABLE SACH_TACGIA (
    maSach NVARCHAR(50) NOT NULL,
    maTacGia NVARCHAR(50) NOT NULL,
    
    /* Khóa ngoại trỏ đến SACH (tự động xóa link nếu Sách bị xóa) */
    CONSTRAINT FK_SachTacGia_Sach FOREIGN KEY (maSach) 
        REFERENCES SACH(maSach) ON DELETE CASCADE,
        
    /* Khóa ngoại trỏ đến TACGIA (tự động xóa link nếu Tác giả bị xóa) */
    CONSTRAINT FK_SachTacGia_TacGia FOREIGN KEY (maTacGia) 
        REFERENCES TACGIA(maTacGia) ON DELETE CASCADE,
        
    /* Khóa chính tổ hợp (đảm bảo 1 tác giả chỉ được gán 1 lần cho 1 sách) */
    PRIMARY KEY (maSach, maTacGia)
);


/* --- CÁC BẢNG KHÁC GIỮ NGUYÊN --- */

CREATE TABLE DOCGIA (
    maDocGia NVARCHAR(50) PRIMARY KEY,
    hoTen NVARCHAR(100) NOT NULL,
    ngaySinh DATE NULL,
    email NVARCHAR(100) NULL,
    diaChi NVARCHAR(255) NULL,
    sdt NVARCHAR(20) NULL,
    blocked BIT NOT NULL DEFAULT 0
);

CREATE TABLE BOSUUTAP (
    maBoSuuTap INT IDENTITY(1,1) PRIMARY KEY,
    tenBoSuuTap NVARCHAR(255) NOT NULL,
    moTa NTEXT NULL,
    duongDanAnh NVARCHAR(255) NULL
);

CREATE TABLE BOSUUTAP_SACH (
    maBoSuuTap INT NOT NULL,
    maSach NVARCHAR(50) NOT NULL,
    CONSTRAINT FK_BSTSach_BoSuuTap FOREIGN KEY (maBoSuuTap) 
        REFERENCES BOSUUTAP(maBoSuuTap) ON DELETE CASCADE,
    CONSTRAINT FK_BSTSach_Sach FOREIGN KEY (maSach) 
        REFERENCES SACH(maSach) ON DELETE CASCADE,
    PRIMARY KEY (maBoSuuTap, maSach)
);

CREATE TABLE MUONTRA (
    maMuonTra INT IDENTITY(1,1) PRIMARY KEY,
    maDocGia NVARCHAR(50) NOT NULL,
    maSach NVARCHAR(50) NOT NULL,
    ngayMuon DATETIME NOT NULL DEFAULT GETDATE(),
    ngayHenTra DATETIME NOT NULL,
    ngayTraThucTe DATETIME NULL,
    trangThai NVARCHAR(50) NULL,
    loaiMuon NVARCHAR(50) NULL,
    CONSTRAINT FK_MuonTra_DocGia FOREIGN KEY (maDocGia) REFERENCES DOCGIA(maDocGia),
    CONSTRAINT FK_MuonTra_Sach FOREIGN KEY (maSach) REFERENCES SACH(maSach)
);
ALTER TABLE DOCGIA
ADD duongDanAnh NVARCHAR(255) NULL;

ALTER TABLE DOCGIA
ADD isArchived BIT NOT NULL DEFAULT 0;
