/* 1. Bảng TACGIA (Không đổi) */
CREATE TABLE TACGIA (
    maTacGia NVARCHAR(50) PRIMARY KEY,
    tenTacGia NVARCHAR(100) NOT NULL,
    email NVARCHAR(100) NULL,
    sdt NVARCHAR(20) NULL,
    chucDanh NVARCHAR(100) NULL
);

/* 2. Bảng SACH (Đã BỎ cột maTacGia) */
CREATE TABLE SACH (
    maSach NVARCHAR(50) PRIMARY KEY,
    tenSach NVARCHAR(255) NOT NULL,
    
    /* --- ĐÃ BỎ CỘT maTacGia VÀ KHÓA NGOẠI TẠI ĐÂY --- */
    
    nhaXuatBan NVARCHAR(150) NULL,
    namXuatBan INT NULL,
    soLuong INT NOT NULL DEFAULT 0,
    moTa NTEXT NULL,
    duongDanAnh NVARCHAR(255) NULL,
    viTri NVARCHAR(100) NULL,
    ngayThem DATETIME NOT NULL DEFAULT GETDATE(),
    isArchived BIT NOT NULL DEFAULT 0,
    conLai INT NOT NULL DEFAULT 0
);

/* 3. Bảng TRUNG GIAN (MỚI) để liên kết Nhiều-Nhiều */
CREATE TABLE SACH_TACGIA (
    maSach NVARCHAR(50) NOT NULL,
    maTacGia NVARCHAR(50) NOT NULL,
    
    /* Khóa ngoại trỏ đến SACH (tự động xóa link nếu Sách bị xóa) */
    CONSTRAINT FK_SachTacGia_Sach FOREIGN KEY (maSach) 
        REFERENCES SACH(maSach) ON DELETE CASCADE,
        
    /* Khóa ngoại trỏ đến TACGIA (tự động xóa link nếu Tác giả bị xóa) */
    CONSTRAINT FK_SachTacGia_TacGia FOREIGN KEY (maTacGia) 
        REFERENCES TACGIA(maTacGia) ON DELETE CASCADE,
        
    /* Khóa chính tổ hợp (đảm bảo 1 tác giả chỉ được gán 1 lần cho 1 sách) */
    PRIMARY KEY (maSach, maTacGia)
);


/* --- CÁC BẢNG KHÁC GIỮ NGUYÊN --- */

CREATE TABLE DOCGIA (
    maDocGia NVARCHAR(50) PRIMARY KEY,
    hoTen NVARCHAR(100) NOT NULL,
    ngaySinh DATE NULL,
    email NVARCHAR(100) NULL,
    diaChi NVARCHAR(255) NULL,
    sdt NVARCHAR(20) NULL,
    blocked BIT NOT NULL DEFAULT 0
);

CREATE TABLE BOSUUTAP (
    maBoSuuTap INT IDENTITY(1,1) PRIMARY KEY,
    tenBoSuuTap NVARCHAR(255) NOT NULL,
    moTa NTEXT NULL,
    duongDanAnh NVARCHAR(255) NULL
);

CREATE TABLE BOSUUTAP_SACH (
    maBoSuuTap INT NOT NULL,
    maSach NVARCHAR(50) NOT NULL,
    CONSTRAINT FK_BSTSach_BoSuuTap FOREIGN KEY (maBoSuuTap) 
        REFERENCES BOSUUTAP(maBoSuuTap) ON DELETE CASCADE,
    CONSTRAINT FK_BSTSach_Sach FOREIGN KEY (maSach) 
        REFERENCES SACH(maSach) ON DELETE CASCADE,
    PRIMARY KEY (maBoSuuTap, maSach)
);

CREATE TABLE MUONTRA (
    maMuonTra INT IDENTITY(1,1) PRIMARY KEY,
    maDocGia NVARCHAR(50) NOT NULL,
    maSach NVARCHAR(50) NOT NULL,
    ngayMuon DATETIME NOT NULL DEFAULT GETDATE(),
    ngayHenTra DATETIME NOT NULL,
    ngayTraThucTe DATETIME NULL,
    trangThai NVARCHAR(50) NULL,
    loaiMuon NVARCHAR(50) NULL,
    CONSTRAINT FK_MuonTra_DocGia FOREIGN KEY (maDocGia) REFERENCES DOCGIA(maDocGia),
    CONSTRAINT FK_MuonTra_Sach FOREIGN KEY (maSach) REFERENCES SACH(maSach)
);
ALTER TABLE DOCGIA
ADD duongDanAnh NVARCHAR(255) NULL;

ALTER TABLE DOCGIA
ADD isArchived BIT NOT NULL DEFAULT 0;

ALTER TABLE BOSUUTAP
DROP COLUMN moTa;
CREATE TABLE TAIKHOAN (
    tenDangNhap NVARCHAR(100) PRIMARY KEY,      -- Tên tài khoản (dùng khi đăng nhập)
    matKhau NVARCHAR(256) NOT NULL,             -- Mật khẩu (hash SHA-256)
    tenNguoiDung NVARCHAR(150) NOT NULL,        -- Tên người dùng (Tên hiển thị)
    email NVARCHAR(100) NULL,                   -- Email người dùng
    sdt NVARCHAR(20) NULL,                      -- SĐT người dùng
    duongDanAnh NVARCHAR(255) NULL,             -- Ảnh người dùng (lưu đường dẫn file)
    
    -- Đặt 'admin' làm mặc định, vì dự án này chỉ có admin
    quyen NVARCHAR(50) NOT NULL DEFAULT 'admin' 
);
-- Bước 1: Thêm cột mới 'nguoiTao' vào bảng MUONTRA
ALTER TABLE MUONTRA
ADD nguoiTao NVARCHAR(100) NULL; -- Phải cho phép NULL

-- Bước 2: Thêm Khóa Ngoại (Foreign Key) với quy tắc "ON DELETE SET NULL"
ALTER TABLE MUONTRA
ADD CONSTRAINT FK_MuonTra_TaiKhoan_NguoiTao
    FOREIGN KEY (nguoiTao)
    REFERENCES TAIKHOAN(tenDangNhap)
    ON DELETE SET NULL; -- <-- Quy tắc an toàn khi xóa tài khoản admin

INSERT INTO TAIKHOAN (tenDangNhap, matKhau, tenNguoiDung, email, sdt, quyen)
VALUES (
    'admin', 
    '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', -- Đây là hash SHA-256 của "admin123"
    'Quản Trị Viên', 
    'admin@thuvien.com', 
    '0123456789', 
    'admin'
);

ALTER TABLE TAIKHOAN
ALTER COLUMN matKhau NVARCHAR(100) NOT NULL;
GO


UPDATE TAIKHOAN
SET matKhau = 'admin123'
WHERE tenDangNhap = 'admin';
GO
UPDATE TAIKHOAN
SET tenNguoiDung = N'Quản Trị Viên' -- <<< Thêm chữ N ở đây
WHERE tenDangNhap = 'admin';

ALTER TABLE MUONTRA
DROP CONSTRAINT FK_MuonTra_TaiKhoan_NguoiTao;
GO
ALTER TABLE TAIKHOAN
DROP CONSTRAINT PK__TAIKHOAN__59267D4B74D87D63;
GO

ALTER TABLE TAIKHOAN
ADD maTaiKhoan INT IDENTITY(1,1) NOT NULL PRIMARY KEY;
GO
ALTER TABLE TAIKHOAN
ADD CONSTRAINT UQ_TenDangNhap UNIQUE(tenDangNhap);
GO

ALTER TABLE MUONTRA
DROP COLUMN nguoiTao;
GO

ALTER TABLE MUONTRA
ADD maNguoiTao INT NULL;
GO

ALTER TABLE MUONTRA
ADD CONSTRAINT FK_MuonTra_TaiKhoan_MaNguoiTao
    FOREIGN KEY (maNguoiTao)
    REFERENCES TAIKHOAN(maTaiKhoan)
    ON DELETE SET NULL; -- (Giữ nguyên quy tắc ON DELETE SET NULL)
GO
ALTER TABLE SACH
DROP COLUMN moTa;
GO

