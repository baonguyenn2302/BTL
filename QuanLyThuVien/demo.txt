CREATE TABLE TACGIA (
    maTacGia VARCHAR(255) PRIMARY KEY NOT NULL, -- Khóa chính
    tenTacGia NVARCHAR(255) NOT NULL,          -- Tên tác giả (để hiển thị, có thể khác maTacGia sau này)
    email VARCHAR(255) NULL,                   -- Email (có thể null)
    sdt VARCHAR(20) NULL,                      -- Số điện thoại (có thể null)
    trinhDoChuyenMon NVARCHAR(MAX) NULL,       -- Trình độ chuyên môn (có thể null, text dài)
    chucDanh NVARCHAR(255) NULL                -- Chức danh (có thể null)
);
GO

-- Phần 1: Chèn các tác giả duy nhất từ bảng SACH vào bảng TACGIA
-- Lệnh này sẽ bỏ qua nếu tên tác giả đã tồn tại trong TACGIA (do là khóa chính)
INSERT INTO TACGIA (tenTacGia)
SELECT DISTINCT tacGia
FROM SACH
WHERE tacGia IS NOT NULL AND tacGia <> ''
AND tacGia NOT IN (SELECT tenTacGia FROM TACGIA); -- Chỉ thêm nếu chưa có
GO

-- Phần 2: Tạo ràng buộc khóa ngoại trên bảng SACH
-- Đảm bảo cột SACH.tacGia có kiểu dữ liệu khớp với TACGIA.tenTacGia (NVARCHAR(255))
-- Nếu kiểu dữ liệu khác, bạn cần ALTER COLUMN trước khi thêm constraint.
-- Ví dụ: ALTER TABLE SACH ALTER COLUMN tacGia NVARCHAR(255) NULL; (chạy nếu cần)

ALTER TABLE SACH
ADD CONSTRAINT FK_Sach_TacGia_Ten FOREIGN KEY (tacGia) REFERENCES TACGIA(tenTacGia)
    ON DELETE SET NULL -- Nếu xóa tác giả, sách sẽ có tacGia là NULL
    ON UPDATE CASCADE; -- Nếu tên tác giả (khóa chính) thay đổi, cập nhật trong sách
GO
-- các lệnh tạo bảng bộ sưu tập có 2 bảng tạo lần lượt từng bảng nhá
/* * Bảng 5: BOSUUTAP
 * Lưu trữ thông tin của các bộ sưu tập (ví dụ: "Sách mới", "Văn học Kinh điển")
 */
CREATE TABLE BOSUUTAP (
    maBoSuuTap INT IDENTITY(1,1) PRIMARY KEY,
    -- IDENTITY(1,1) tự động tạo ID tăng dần (1, 2, 3...)
    
    tenBoSuuTap NVARCHAR(255) NOT NULL,
    -- Tên hiển thị của bộ sưu tập
    
    moTa NVARCHAR(MAX) NULL
    -- Mô tả chi tiết (tùy chọn)
);

/* * Bảng 6: SACH_BOSUUTAP
 * Bảng trung gian để tạo quan hệ Nhiều-Nhiều (Một sách có thể ở nhiều BST, 
 * và một BST có thể chứa nhiều sách)
 */
CREATE TABLE SACH_BOSUUTAP (
    maSach NVARCHAR(20) NOT NULL,
    -- Phải trùng kiểu dữ liệu với cột 'maSach' trong bảng 'SACH'
    
    maBoSuuTap INT NOT NULL,
    -- Phải trùng kiểu dữ liệu với cột 'maBoSuuTap' trong bảng 'BOSUUTAP'
    
    -- 1. Tạo Khóa chính phức hợp:
    -- Đảm bảo một cuốn sách không thể bị thêm 2 lần vào CÙNG MỘT bộ sưu tập
    PRIMARY KEY (maSach, maBoSuuTap),
    
    -- 2. Tạo Khóa ngoại (Foreign Keys)
    -- Liên kết đến bảng SACH
    CONSTRAINT FK_Sach_BST_Sach FOREIGN KEY (maSach)
        REFERENCES SACH(maSach)
        ON DELETE CASCADE, -- Nếu sách bị xóa, liên kết này cũng bị xóa
        
    -- Liên kết đến bảng BOSUUTAP
    CONSTRAINT FK_Sach_BST_BoSuuTap FOREIGN KEY (maBoSuuTap)
        REFERENCES BOSUUTAP(maBoSuuTap)
        ON DELETE CASCADE -- Nếu bộ sưu tập bị xóa, liên kết này cũng bị xóa
);
